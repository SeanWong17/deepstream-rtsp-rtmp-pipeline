# Python DeepStream RTSP-to-RTMP é«˜æ€§èƒ½è§†é¢‘å¤„ç†ç®¡çº¿

[![Python Version](https://img.shields.io/badge/Python-3.8%2B-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Docker](https://img.shields.io/badge/Docker-Supported-blue.svg)](https://www.docker.com/)

ä¸€ä¸ªåŸºäº Python å’Œ NVIDIA DeepStream çš„é«˜æ€§èƒ½è§†é¢‘å¤„ç†è„šæ‰‹æ¶ï¼Œæ¼”ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªä» RTSP æ‹‰æµã€ç»ç”± GPU è§£ç å¤„ç†ã€å†åˆ° GPU ç¼–ç æ¨å‘ RTMP æœåŠ¡å™¨çš„å®Œæ•´ç®¡çº¿ã€‚

## ğŸ“ é¡¹ç›®ç®€ä»‹

åœ¨è§†é¢‘ç›‘æ§ã€æ™ºèƒ½äº¤é€šã€å®‰é˜²ç­‰åœºæ™¯ä¸‹ï¼Œå®æ—¶è§†é¢‘æµåˆ†æçš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚ä¼ ç»Ÿçš„åŸºäº CPU çš„ç¼–è§£ç æ–¹å¼åœ¨é«˜åˆ†è¾¨ç‡æˆ–é«˜å¸§ç‡è§†é¢‘å¤„ç†ä¸Šå¾€å¾€ä¼šé‡åˆ°æ€§èƒ½ç“¶é¢ˆã€‚

æœ¬é¡¹ç›®åˆ©ç”¨ **NVIDIA DeepStream**ï¼Œå……åˆ†å‘æŒ¥ GPU çš„å¼ºå¤§å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼Œå¯¹è§†é¢‘æµè¿›è¡Œé«˜æ•ˆçš„ç¡¬ä»¶åŠ é€Ÿç¼–è§£ç å’Œå¤„ç†ï¼Œå¤§å¹…æå‡æ•´ä½“æ€§èƒ½ã€‚ç»“åˆ Python çš„ç®€æ´æ˜“ç”¨æ€§ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ªå¿«é€Ÿã€é«˜æ•ˆä¸”æ˜“äºæ‰©å±•çš„è§†é¢‘åˆ†æè§£å†³æ–¹æ¡ˆã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- **ğŸš€ é«˜æ•ˆçš„ GPU ç¼–è§£ç **: åˆ©ç”¨ NVIDIA GPU (NVDEC/NVENC) è¿›è¡Œç¡¬ä»¶åŠ é€Ÿï¼Œè½»æ¾å¤„ç†é«˜åˆ†è¾¨ç‡ã€é«˜å¸§ç‡è§†é¢‘ï¼Œä¿è¯ä½å»¶è¿Ÿå’Œå®æ—¶æ€§ã€‚
- **ğŸ Python é©±åŠ¨**: ä½¿ç”¨ Python åŠå…¶ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿè¿›è¡Œå¼€å‘ï¼Œè¯­æ³•ç®€æ´ï¼Œä¸Šæ‰‹å¿«ï¼Œæ–¹ä¾¿å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å’Œç®—æ³•å®ç°ã€‚
- **ğŸ§© æä½³çš„æ‰©å±•æ€§**: åŸºäº GStreamer çš„æ¨¡å—åŒ–ç®¡çº¿æ¶æ„ï¼Œå¯è½»æ¾é›†æˆ OpenCVã€PyTorch/TensorFlow ç­‰ AI æ¨ç†æ¡†æ¶ï¼Œå®ç°è‡ªå®šä¹‰çš„è§†é¢‘åˆ†æã€ç›®æ ‡æ£€æµ‹å’Œå‘Šè­¦é€»è¾‘ã€‚
- **ğŸ“¦ DockeråŒ–éƒ¨ç½²**: æä¾› `Dockerfile`ï¼Œä¸€é”®å°è£…ç¯å¢ƒä¾èµ–ï¼Œç®€åŒ–åœ¨æœåŠ¡å™¨æˆ–è¾¹ç¼˜è®¾å¤‡ä¸Šçš„éƒ¨ç½²æµç¨‹ã€‚
- **ğŸ”§ çº¿ç¨‹å®‰å…¨è®¾è®¡**: è§£ç ã€å¤„ç†å’Œç¼–ç åœ¨ä¸åŒçº¿ç¨‹ä¸­è¿›è¡Œï¼Œé€šè¿‡çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—äº¤æ¢æ•°æ®ï¼Œç¡®ä¿æµç¨‹ç¨³å®šé«˜æ•ˆã€‚

## âš™ï¸ æŠ€æœ¯æ¶æ„

æœ¬é¡¹ç›®çš„æ ¸å¿ƒæµç¨‹åˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç¯èŠ‚ï¼š

1.  **è§£ç  (Decode)**:
    * `rtspsrc` ä»æŒ‡å®šçš„ RTSP åœ°å€æ‹‰å–è§†é¢‘æµã€‚
    * `nvv4l2decoder` åˆ©ç”¨ GPU å¯¹ H.264 è§†é¢‘æµè¿›è¡Œç¡¬ä»¶è§£ç ã€‚
    * `nvvideoconvert` å°†è§£ç åçš„å¸§è½¬æ¢ä¸º CPU å†…å­˜ä¸­çš„ BGR æ ¼å¼ã€‚
    * `appsink` å°† BGR å¸§æ¨é€ç»™ Python åº”ç”¨å±‚è¿›è¡Œå¤„ç†ã€‚

2.  **å¤„ç† (Process)**:
    * åœ¨ç‹¬ç«‹çš„ Python çº¿ç¨‹ä¸­ï¼Œä»é˜Ÿåˆ—ä¸­è·å– BGR å¸§ã€‚
    * ä½¿ç”¨ OpenCV ç­‰åº“è¿›è¡Œå›¾åƒå¤„ç†ï¼ˆç¤ºä¾‹ä¸­ä¸ºç»˜åˆ¶çŸ©å½¢å’Œæ–‡å­—ï¼‰ã€‚
    * **æ­¤ç¯èŠ‚æ˜¯é›†æˆ AI æ¨ç†ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ã€è·Ÿè¸ªç­‰ï¼‰çš„æ ¸å¿ƒä½ç½®**ã€‚

3.  **ç¼–ç ä¸æ¨æµ (Encode & Push)**:
    * `appsrc` æ¥æ”¶ Python åº”ç”¨å±‚å¤„ç†åçš„ BGR å¸§ã€‚
    * `nvvideoconvert` å°† BGR å¸§è½¬æ¢å› GPU å†…å­˜æ ¼å¼ã€‚
    * `nvv4l2h264enc` åˆ©ç”¨ GPU å°†è§†é¢‘å¸§é«˜æ•ˆç¼–ç ä¸º H.264 æ ¼å¼ã€‚
    * `flvmux` å°† H.264 ç æµå°è£…ä¸º FLV æ ¼å¼ã€‚
    * `rtmpsink` å°†æœ€ç»ˆçš„è§†é¢‘æµæ¨é€åˆ°æŒ‡å®šçš„ RTMP æœåŠ¡å™¨ã€‚

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡ä¸è¿è¡Œ

### å…ˆå†³æ¡ä»¶

-   NVIDIA æ˜¾å¡ (Pascal æ¶æ„æˆ–æ›´é«˜)
-   [NVIDIA é©±åŠ¨](https://www.nvidia.com/Download/index.aspx) >= 525.85.12
-   [Docker](https://docs.docker.com/engine/install/)
-   [NVIDIA Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)

### å¿«é€Ÿå¼€å§‹ (ä½¿ç”¨ Docker)

1.  **å…‹éš†é¡¹ç›®**
    ```bash
    git clone [https://github.com/your-username/deepstream-rtsp-rtmp-pipeline.git](https://github.com/your-username/deepstream-rtsp-rtmp-pipeline.git)
    cd deepstream-rtsp-rtmp-pipeline
    ```

2.  **æ„å»º Docker é•œåƒ**
    æœ¬é¡¹ç›®åŸºäº `deepstream:6.3-gc-triton-devel` é•œåƒï¼Œå·²åŒ…å«å¤§éƒ¨åˆ†ä¾èµ–ã€‚
    ```bash
    docker build -t deepstream-pipeline .
    ```

3.  **ä¿®æ”¹é…ç½®**
    æ‰“å¼€ `main.py` æ–‡ä»¶ï¼Œä¿®æ”¹åº•éƒ¨çš„ `if __name__ == "__main__"` éƒ¨åˆ†ï¼Œå¡«å…¥ä½ è‡ªå·±çš„ RTSP è¾“å…¥åœ°å€å’Œ RTMP è¾“å‡ºåœ°å€ã€‚
    ```python
    if __name__ == "__main__":
        rtsp_url = "rtsp://your.rtsp.stream/url"  # ä½ çš„RTSPè¾“å…¥åœ°å€
        rtmp_url = "rtmp://your.rtmp.server/live/stream_key" # ä½ çš„RTMPè¾“å‡ºåœ°å€
        width = 1920
        height = 1080
        # ...
    ```

4.  **è¿è¡Œå®¹å™¨**
    ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼Œå®ƒå°†è‡ªåŠ¨è¿è¡Œå¤„ç†ç¨‹åºã€‚
    ```bash
    docker run --gpus all -it --rm --net=host deepstream-pipeline
    ```
    * `--gpus all`: å°†ä¸»æœºçš„ NVIDIA GPU æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚
    * `--net=host`: ä½¿ç”¨ä¸»æœºç½‘ç»œï¼Œæ–¹ä¾¿è®¿é—® RTSP å’Œ RTMP æœåŠ¡å™¨ã€‚
    * `--rm`: å®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤ã€‚

    è¿è¡Œåï¼Œä½ å°†çœ‹åˆ° "DeepStream Processor æ­£åœ¨è¿è¡Œ..." çš„æ—¥å¿—ã€‚æ­¤æ—¶ï¼Œå¯ä»¥ä»ä½ çš„ RTMP æœåŠ¡å™¨ä¸Šçœ‹åˆ°å¤„ç†åçš„è§†é¢‘æµã€‚

## ğŸ§© ä»£ç è§£æ

æ ¸å¿ƒé€»è¾‘å°è£…åœ¨ `main.py` çš„ `DeepStreamProcessor` ç±»ä¸­ã€‚

-   `build_decode_pipeline()`: æ„å»ºä» `rtspsrc` åˆ° `appsink` çš„è§£ç ç®¡çº¿ã€‚
-   `build_encode_pipeline()`: æ„å»ºä» `appsrc` åˆ° `rtmpsink` çš„ç¼–ç æ¨æµç®¡çº¿ã€‚
-   `on_new_sample()`: `appsink` çš„å›è°ƒå‡½æ•°ï¼Œå½“æœ‰æ–°å¸§è§£ç å®Œæˆæ—¶è§¦å‘ï¼Œå°†å¸§æ”¾å…¥ `frame_queue`ã€‚
-   `processing_loop()`: åå°å¤„ç†çº¿ç¨‹çš„æ ¸å¿ƒã€‚å®ƒä» `frame_queue` ä¸­å–å‡ºå¸§ï¼Œè¿›è¡Œå¤„ç†ï¼ˆ**å¯åœ¨æ­¤å¤„æ·»åŠ AIæ¨ç†**ï¼‰ï¼Œç„¶åè°ƒç”¨ `push_frame_to_appsrc()`ã€‚
-   `push_frame_to_appsrc()`: å°†å¤„ç†åçš„å¸§å’Œè®¡ç®—å¥½çš„æ—¶é—´æˆ³ï¼ˆPTSï¼‰æ¨é€åˆ° `appsrc`ï¼Œé€å…¥ç¼–ç ç®¡çº¿ã€‚
-   `start()` / `stop()`: æ§åˆ¶æ•´ä¸ªç®¡çº¿çš„å¯åŠ¨å’Œä¼˜é›…åœæ­¢ã€‚

## ğŸš€ æ‰©å±•æ€è·¯

-   **é›†æˆ AI æ¨¡å‹**: åœ¨ `processing_loop` æ–¹æ³•ä¸­ï¼ŒåŠ è½½ä¸€ä¸ªç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼ˆå¦‚ YOLOã€Faster R-CNNï¼‰ã€‚å¯¹æ¯ä¸€å¸§æ‰§è¡Œæ¨ç†ï¼Œå¹¶å°†æ£€æµ‹æ¡†ç»˜åˆ¶åœ¨å›¾åƒä¸Šã€‚
-   **æ€§èƒ½ä¼˜åŒ–**:
    * å¦‚æœå¤„ç†é€»è¾‘å¤æ‚ï¼Œå¯å°† `processing_loop` æ‹†åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹ï¼Œå½¢æˆå¤„ç†æµæ°´çº¿ã€‚
    * è°ƒæ•´ `nvv4l2h264enc` çš„ `bitrate` å’Œ `iframeinterval` å‚æ•°ä»¥ä¼˜åŒ–ç ç‡å’Œç”»è´¨ã€‚
-   **å¤šè·¯è§†é¢‘å¤„ç†**: å®ä¾‹åŒ–å¤šä¸ª `DeepStreamProcessor` å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡å¤„ç†ä¸€è·¯è§†é¢‘æµã€‚æ³¨æ„åˆç†åˆ†é… GPU èµ„æºã€‚
-   **æ·»åŠ å‘Šè­¦é€»è¾‘**: å½“æ£€æµ‹åˆ°ç‰¹å®šäº‹ä»¶ï¼ˆå¦‚æœ‰äººé—¯å…¥ç¦åŒºï¼‰ï¼Œå¯é€šè¿‡ç‹¬ç«‹çš„çº¿ç¨‹å‘é€å‘Šè­¦ä¿¡æ¯ï¼ˆå¦‚è°ƒç”¨ APIã€å‘é€æ¶ˆæ¯åˆ° Kafka/MQTTï¼‰ã€‚

## ğŸ“„ License

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºã€‚
